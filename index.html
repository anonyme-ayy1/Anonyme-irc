<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON PROTOCOL // SECURE CHAT</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- ARCHITECTURE CSS AVANCÉE (CYBERPUNK) --- */
        :root {
            --bg-ultra: #020202;
            --panel-hex: #0a0a0c;
            --neon-main: #00ff41;
            --neon-glow: rgba(0, 255, 65, 0.2);
            --cyber-blue: #00f3ff;
            --alert-red: #ff003c;
            --text-dim: #888;
            --text-bright: #e0e0e0;
        }

        * { box-sizing: border-box; outline: none; }
        body {
            margin: 0; padding: 0; background: var(--bg-ultra);
            color: var(--text-bright); font-family: 'JetBrains Mono', monospace;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* Scanlines & Grain Effet Cyber */
        body::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 100; pointer-events: none; background-size: 100% 3px, 3px 100%;
        }

        /* Header Statut */
        header {
            background: var(--panel-hex); border-bottom: 2px solid var(--neon-main);
            padding: 15px 25px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.1); z-index: 10;
        }

        .sys-info { display: flex; flex-direction: column; gap: 4px; }
        .pulse { width: 10px; height: 10px; background: var(--neon-main); border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 10px var(--neon-main); animation: blink 1.5s infinite; }

        /* Zone de Messages */
        #chat-window {
            flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column;
            gap: 20px; scroll-behavior: smooth; background-image: url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
        }

        .msg-block { align-self: flex-start; max-width: 75%; animation: slide 0.3s ease; }
        .msg-block.own { align-self: flex-end; }

        .bubble {
            padding: 15px; background: rgba(15, 15, 15, 0.9); border: 1px solid #222;
            border-left: 4px solid var(--neon-main); box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            word-wrap: break-word;
        }
        .msg-block.own .bubble { border-left: none; border-right: 4px solid var(--cyber-blue); }

        .bubble img { max-width: 100%; margin-top: 10px; border: 1px solid #333; cursor: zoom-in; }
        
        .meta { font-size: 0.7rem; color: var(--text-dim); margin-top: 6px; display: flex; justify-content: space-between; }

        /* Typing Indicator */
        #typing { font-size: 0.75rem; color: var(--neon-main); padding: 5px 30px; height: 20px; font-style: italic; }

        /* Footer Barre de Saisie */
        footer {
            background: var(--panel-hex); padding: 20px; border-top: 1px solid #222;
            display: flex; gap: 15px; align-items: center; z-index: 101;
        }

        .input-group { flex: 1; position: relative; display: flex; align-items: center; }
        
        input[type="text"] {
            width: 100%; background: #000; border: 1px solid #333; color: var(--neon-main);
            padding: 15px 45px 15px 15px; font-family: inherit; font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        input[type="text"]:focus { border-color: var(--neon-main); box-shadow: 0 0 15px var(--neon-glow); }

        .btn-action {
            background: none; border: 1px solid var(--neon-main); color: var(--neon-main);
            padding: 12px 25px; cursor: pointer; font-weight: bold; text-transform: uppercase;
            letter-spacing: 1px; transition: 0.3s;
        }
        .btn-action:hover { background: var(--neon-main); color: #000; box-shadow: 0 0 20px var(--neon-main); }

        .btn-file { border-color: var(--cyber-blue); color: var(--cyber-blue); }
        .btn-file:hover { background: var(--cyber-blue); color: #000; }

        #file-input { display: none; }

        /* Animations */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes slide { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--neon-main); }
    </style>
</head>
<body>

<header>
    <div class="sys-info">
        <div><span class="pulse"></span><span class="online-text" id="status-label">ENCRYPTION_ACTIVE</span></div>
        <div style="font-size: 0.6rem; color: var(--text-dim)">FREQ: 2.4GHZ // DATA_STREAM: OK</div>
    </div>
    <div style="text-align: center;">
        <h2 style="margin:0; font-size: 1.1rem; letter-spacing: 3px; color: var(--cyber-blue)">NET_RUNNER // HQ</h2>
    </div>
    <button id="purge-cmd" class="btn-action" style="border-color: var(--alert-red); color: var(--alert-red); font-size: 0.7rem;">PURGE_ALL</button>
</header>

<main id="chat-window"></main>

<div id="typing"></div>

<footer>
    <label for="file-input" class="btn-action btn-file" title="Upload Binary">UPLOAD</label>
    <input type="file" id="file-input">
    
    <div class="input-group">
        <input type="text" id="main-input" placeholder="Attente de commande..." spellcheck="false" autocomplete="off">
    </div>

    <button id="send-cmd" class="btn-action">EXECUTE</button>
</footer>

<audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

<script type="module">
    // --- IMPORTATION MODULES FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDocs, deleteDoc, serverTimestamp, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // --- 1. CONFIGURATION FIREBASE (CORRIGÉE ET REMPLIE) ---
    // Ces clés proviennent de ta configuration "message-78403"
    const firebaseConfig = {
        apiKey: "AIzaSyDyXoEthAys6BkhuQVfMc9lg-Fp0tIdq9o",
        authDomain: "message-78403.firebaseapp.com",
        projectId: "message-78403",
        storageBucket: "message-78403.firebasestorage.app", // Correction ici (.firebasestorage.app au lieu de .appspot.com)
        messagingSenderId: "450004953311",
        appId: "1:450004953311:web:cfd7cd647ef5383458a16a"
    };

    // Initialisation de l'application
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Éléments DOM
    const win = document.getElementById('chat-window');
    const input = document.getElementById('main-input');
    const sendBtn = document.getElementById('send-cmd');
    const fileIn = document.getElementById('file-input');
    const typingDiv = document.getElementById('typing');
    const sound = document.getElementById('notif-sound');

    // --- 2. LOGIQUE D'ENVOI ---
    const executeTransmission = async () => {
        const text = input.value.trim();
        if (!text) return;

        // On vide IMMÉDIATEMENT le champ
        input.value = "";
        input.focus();

        try {
            await addDoc(collection(db, "messages"), {
                content: text,
                type: 'text',
                timestamp: serverTimestamp()
            });
        } catch (e) {
            console.error("Error:", e);
            // Si cette alerte s'affiche, c'est souvent que la BDD n'est pas en "Mode Test"
            alert("ÉCHEC DE TRANSMISSION : Vérifie que Firestore est en mode Test.");
        }
    };

    // --- 3. GESTION DES FICHIERS ---
    fileIn.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        typingDiv.innerText = ">> UPLOADING BINARY DATA...";
        try {
            const sRef = ref(storage, `data_logs/${Date.now()}_${file.name}`);
            await uploadBytes(sRef, file);
            const link = await getDownloadURL(sRef);

            await addDoc(collection(db, "messages"), {
                content: link,
                name: file.name,
                type: file.type.startsWith('image/') ? 'image' : 'file',
                timestamp: serverTimestamp()
            });
            typingDiv.innerText = "";
        } catch (err) { 
            console.error(err);
            alert("ERROR_UPLOAD_FAILED : Vérifie les règles Storage."); 
            typingDiv.innerText = "";
        }
    };

    // --- 4. RÉCEPTION ET NOTIFICATION ---
    let firstLoad = true;
    
    // Écoute en temps réel de la collection "messages"
    onSnapshot(query(collection(db, "messages"), orderBy("timestamp", "asc")), (snap) => {
        win.innerHTML = ''; // Nettoyage
        snap.forEach(dDoc => {
            const data = dDoc.data();
            renderMsg(data);
        });
        
        // Auto-scroll vers le bas
        win.scrollTop = win.scrollHeight;

        // Jouer un son (avec protection anti-erreur)
        if (!firstLoad && sound) {
            sound.play().catch(e => console.log("Son bloqué (interaction requise)"));
        }
        firstLoad = false;
    });

    function renderMsg(data) {
        const block = document.createElement('div');
        block.className = 'msg-block';
        
        // Conversion sécurisée du timestamp
        const dateObj = data.timestamp ? data.timestamp.toDate() : new Date();
        const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const dateStr = dateObj.toLocaleDateString([], {day: 'numeric', month: 'short'});

        let htmlContent = "";
        if(data.type === 'text') {
            // Protection basique contre l'injection de code HTML
            htmlContent = `<div>${data.content.replace(/</g, "&lt;")}</div>`;
        } else if(data.type === 'image') {
            htmlContent = `<div style="font-size:0.6rem; color:var(--cyber-blue)">[IMAGE_INBOUND]</div><img src="${data.content}">`;
        } else {
            htmlContent = `<a href="${data.content}" target="_blank" style="color:var(--cyber-blue); text-decoration:none;">>> DOWNLOAD: ${data.name}</a>`;
        }

        block.innerHTML = `
            <div class="bubble">${htmlContent}</div>
            <div class="meta"><span>${dateStr}</span><span>${timeStr}</span></div>
        `;
        win.appendChild(block);
    }

    // --- 5. ÉVÉNEMENTS CLAVIER ---
    sendBtn.onclick = executeTransmission;
    input.onkeydown = (e) => { 
        if(e.key === 'Enter') executeTransmission();
    };

    // --- 6. COMMANDE DE PURGE SÉCURISÉE (ADMIN) ---
    const purgeBtn = document.getElementById('purge-cmd');
    if (purgeBtn) {
        purgeBtn.onclick = async () => {
            const access = prompt("ENTER ROOT AUTHORIZATION CODE:");
            if (access === "123") {
                const querySnap = await getDocs(collection(db, "messages"));
                querySnap.forEach(async (d) => await deleteDoc(d.ref));
                alert("MEMORY_WIPED_SUCCESSFULLY");
            } else if (access !== null) {
                alert("ACCESS_DENIED_INTRUDER_ALERT");
            }
        };
    }
</script>
</body>
</html>